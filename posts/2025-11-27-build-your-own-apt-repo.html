<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="ismdeep">
<meta name="author" content="ismdeep">
<meta name="subtitle" content="Enjoy programming and build awesome stuff.">




<title>快速搭建 apt 仓库构建环境 | ismdeep</title>



<link rel="icon" href="/hacker.svg">



<style>
/* 立即隐藏侧边栏和顶部栏，防止闪烁 */
#column-one, #p-personal {
    visibility: hidden;
    opacity: 0;
}

/* 页面加载完成后显示 */
body.loaded #column-one,
body.loaded #p-personal {
    visibility: visible;
    opacity: 1;
    transition: opacity 0.2s ease-in-out;
}

/* 确保在JavaScript未执行时也能正常显示（降级方案） */
.no-js #column-one,
.no-js #p-personal {
    visibility: visible !important;
    opacity: 1 !important;
}
</style>


<script>
(function() {
    // 立即添加loaded类，不等待DOM加载
    document.documentElement.className += ' no-js';
    
    function showElements() {
        document.body.className = (document.body.className + ' loaded').trim();
        document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '').trim();
    }
    
    // 尝试多种方式确保元素显示
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', showElements);
        // 备用方案：在短延迟后也执行
        setTimeout(showElements, 100);
    } else {
        showElements();
    }
    
    // 最后的保障：在窗口加载完成后也执行
    window.addEventListener('load', showElements);
})();
</script>


<link rel="stylesheet" href="/css/style.css">


<script src="/js/script.js"></script>
<script src="/js/tocbot.min.js"></script>



    
    
        
    


  <meta name="generator" content="Hexo 6.3.0"></head>

  <body class="mediawiki ltr sitedir-ltr mw-underline-never mw-hide-empty-elt ns-0 ns-subject mw-editable skin-monobook action-view skin--responsive">
    <div id="globalWrapper">
      <div id="column-content">
        <div id="content" class="mw-body ve-init-mw-desktopArticleTarget-targetContainer" role="main">
          <a id="top"></a>

          
            <h1 id="firstHeading" class="firstHeading mw-first-heading" lang="zh-Hans-CN" dir="ltr">
              <span class="mw-page-title-main">快速搭建 apt 仓库构建环境</span>
            </h1>
          

          <div id="bodyContent" class="monobook-body">
            <div id="contentSub" lang="zh-Hans-CN" dir="ltr">
              <div id="mw-content-subtitle" lang="zh-Hans-CN" dir="ltr"></div>
            </div>
            <!-- start content -->
            <div id="mw-content-text" class="mw-body-content">
              <div class="mw-content-ltr mw-parser-output" lang="zh-Hans-CN" dir="ltr">
                <div id="noteTA-cab67cdc" class="noteTA">
                  <div class="noteTA-group">
                    <div data-noteta-group-source="module" data-noteta-group="USState"></div>
                    <div data-noteta-group-source="module" data-noteta-group="PresidentsUS"></div>
                    <div data-noteta-group-source="module" data-noteta-group="People"></div>
                  </div>
                </div>
                <div class="container">
    
    

    
    <article class="post-wrap">
<!--         <header class="post-header"> -->
<!--             <h1 class="post-title">快速搭建 apt 仓库构建环境</h1> -->
<!--         </header> -->

        <div class="post-content">
            <p>步骤一、创建子目录</p>
<pre><code>$ mkdir -p ./packages/
</code></pre>
<p>步骤二、创建配置信息文件 <code>meta.json</code></p>
<pre><code>&#123;
  &quot;container_name&quot;: &quot;aptly-repo-builder&quot;,
  &quot;remote_server&quot;: &quot;xx.xx.xx.xx&quot;,
  &quot;remote_dir&quot;: &quot;&lt;remote-dir&gt;&quot;,
  &quot;docker_image&quot;: &quot;&lt;local-target-docker-image-address&gt;&quot;,
  &quot;distribution&quot;: &quot;latest&quot;,
  &quot;component&quot;: &quot;main&quot;
&#125;
</code></pre>
<p>步骤三、创建 <code>build.sh</code> 文件</p>
<pre><code>#!/usr/bin/env bash

set -e

# 日志函数
# 日志颜色代码：URL_ADDRESS# 日志颜色代码：https://misc.flogisoft.com/bash/tip_colors_and_formatting
# 日志格式：时间 [日志级别] 日志内容
# 日志级别：DEBUG, INFO, OK, WARN, ERROR
# 日志颜色：蓝色, 青色, 绿色, 黄色, 红色
# 日志输出：标准输出, 标准错误
# 日志示例：2021-01-01 00:00:00 +0800 [ DEBUG ] hello world.
# 日志示例：2021-01-01 00:00:00 +0800 [ INFO ] hello world.
# 日志示例：2021-01-01 00:00:00 +0800 [ OK ] hello world.
# 日志示例：2021-01-01 00:00:00 +0800 [ WARN ] hello world.
# 日志示例：2021-01-01 00:00:00 +0800 [ ERROR ] hello world.
if [[ &quot;$&#123;TERM&#125;&quot; =~ ^(xterm|screen|vt100) ]]; then
  log_debug() &#123;   echo -e &quot;$(date &#39;+%Y-%m-%d %H:%M:%S %z&#39;) [ \033[34mDEBUG\033[0m ] $*&quot;; &#125;
  log_info() &#123;    echo -e &quot;$(date &#39;+%Y-%m-%d %H:%M:%S %z&#39;) [ \033[36mINFO\033[0m ] $*&quot;; &#125;
  log_success() &#123; echo -e &quot;$(date &#39;+%Y-%m-%d %H:%M:%S %z&#39;) [ \033[32mOK\033[0m ] $*&quot;; &#125;
  log_warn() &#123;    echo -e &quot;$(date &#39;+%Y-%m-%d %H:%M:%S %z&#39;) [ \033[33mWARN\033[0m ] $*&quot; &gt;&amp;2; &#125;
  log_error() &#123;   echo -e &quot;$(date &#39;+%Y-%m-%d %H:%M:%S %z&#39;) [ \033[31mERROR\033[0m ] $*&quot; &gt;&amp;2; &#125;
else
  log_debug() &#123;   echo -e &quot;$(date &#39;+%Y-%m-%d %H:%M:%S %z&#39;) [ DEBUG ] $*&quot;; &#125;
  log_info() &#123;    echo -e &quot;$(date &#39;+%Y-%m-%d %H:%M:%S %z&#39;) [ INFO ] $*&quot;; &#125;
  log_success() &#123; echo -e &quot;$(date &#39;+%Y-%m-%d %H:%M:%S %z&#39;) [ OK ] $*&quot;; &#125;
  log_warn() &#123;    echo -e &quot;$(date &#39;+%Y-%m-%d %H:%M:%S %z&#39;) [ WARN ] $*&quot; &gt;&amp;2; &#125;
  log_error() &#123;   echo -e &quot;$(date &#39;+%Y-%m-%d %H:%M:%S %z&#39;) [ ERROR ] $*&quot; &gt;&amp;2; &#125;
fi

# Get to workdir
cd &quot;$(realpath &quot;$(dirname &quot;$(realpath &quot;$&#123;BASH_SOURCE[0]&#125;&quot;)&quot;)&quot;)&quot;

# jq command is required
command -v jq &gt;/dev/null 2&gt;/dev/null || (log_error &quot;command required: jq&quot; &amp;&amp; false)

# aptly command is required
command -v aptly &gt;/dev/null 2&gt;/dev/null || (log_error &quot;command required: aptly&quot; &amp;&amp; false)

workdir=&quot;$(pwd)&quot;
export APTLY_ROOT_DIR=&quot;$&#123;workdir&#125;/aptly&quot;

mkdir -p &quot;$&#123;APTLY_ROOT_DIR&#125;&quot;

tmpdir=&quot;$(mktemp -d)&quot;

config_file=&quot;$&#123;tmpdir:?&#125;/aptly.conf.json&quot;

&lt; aptly.conf.json.envsubst envsubst &gt; &quot;$&#123;config_file&#125;&quot;

distribution=&quot;$(jq -r &#39;.distribution&#39; meta.json)&quot;
component=&quot;$(jq -r &#39;.component&#39; meta.json)&quot;
log_info &quot;distribution: $&#123;distribution&#125;&quot;
log_info &quot;component: $&#123;component&#125;&quot;

if ! aptly -config=&quot;$&#123;config_file&#125;&quot; repo show &quot;$&#123;distribution&#125;&quot;; then
  # 创建 repo
  aptly -config=&quot;$&#123;config_file&#125;&quot; repo create -distribution=&quot;$&#123;distribution&#125;&quot; -component=&quot;$&#123;component&#125;&quot; &quot;$&#123;distribution&#125;&quot;
  # 添加包
  aptly -config=&quot;$&#123;config_file&#125;&quot; repo add &quot;$&#123;distribution&#125;&quot; ./packages/
  # 发布时禁用硬链接
  aptly -config=&quot;$&#123;config_file&#125;&quot; publish repo &quot;$&#123;distribution&#125;&quot;
else
  # 更新包
  aptly -config=&quot;$&#123;config_file&#125;&quot; repo add &quot;$&#123;distribution&#125;&quot; ./packages/
  # 更新发布时禁用硬链接
  aptly -config=&quot;$&#123;config_file&#125;&quot; publish update &quot;$&#123;distribution&#125;&quot;
fi

echo &quot;$(date -R) [ INFO ] aptly build repo successfully.&quot;

rm -rf &quot;$&#123;tmpdir:?&#125;/&quot;
</code></pre>
<p>步骤四、创建 <code>Dockerfile</code> 文件</p>
<pre><code>FROM docker.1ms.run/library/debian:13
COPY debian.sources /etc/apt/sources.list.d/debian.sources
RUN \
    apt update &amp;&amp; \
    apt upgrade -y &amp;&amp; \
    apt install -y aptly jq gettext-base
</code></pre>
<p>步骤五、创建文件 <code>debian.sources</code></p>
<pre><code>Types: deb
URIs: http://mirrors.tuna.tsinghua.edu.cn/debian
Suites: trixie trixie-updates trixie-backports
Components: main contrib non-free non-free-firmware
Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg

Types: deb
URIs: http://mirrors.tuna.tsinghua.edu.cn/debian-security
Suites: trixie-security
Components: main contrib non-free non-free-firmware
Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg
</code></pre>
<p>步骤六、创建文件 <code>aptly.conf.json.envsubst</code></p>
<pre><code>&#123;
  &quot;rootDir&quot;: &quot;$&#123;APTLY_ROOT_DIR&#125;&quot;,
  &quot;downloadConcurrency&quot;: 4,
  &quot;downloadSpeedLimit&quot;: 0,
  &quot;downloadRetries&quot;: 0,
  &quot;downloader&quot;: &quot;default&quot;,
  &quot;databaseOpenAttempts&quot;: -1,
  &quot;architectures&quot;: [],
  &quot;dependencyFollowSuggests&quot;: false,
  &quot;dependencyFollowRecommends&quot;: false,
  &quot;dependencyFollowAllVariants&quot;: false,
  &quot;dependencyFollowSource&quot;: false,
  &quot;dependencyVerboseResolve&quot;: false,
  &quot;gpgDisableSign&quot;: true,
  &quot;gpgDisableVerify&quot;: true,
  &quot;gpgProvider&quot;: &quot;gpg&quot;,
  &quot;downloadSourcePackages&quot;: false,
  &quot;skipLegacyPool&quot;: true,
  &quot;ppaDistributorID&quot;: &quot;debian&quot;,
  &quot;ppaCodename&quot;: &quot;&quot;,
  &quot;skipContentsPublishing&quot;: false,
  &quot;skipBz2Publishing&quot;: false,
  &quot;FileSystemPublishEndpoints&quot;: &#123;&#125;,
  &quot;S3PublishEndpoints&quot;: &#123;&#125;,
  &quot;SwiftPublishEndpoints&quot;: &#123;&#125;,
  &quot;AzurePublishEndpoints&quot;: &#123;&#125;,
  &quot;AsyncAPI&quot;: false,
  &quot;enableMetricsEndpoint&quot;: false
&#125;
</code></pre>
<p>步骤七、创建 <code>Makefile</code> 文件</p>
<pre><code>SHELL := /bin/bash

container_name := $(shell jq -r &#39;.container_name&#39; meta.json)
remote_server  := $(shell jq -r &#39;.remote_server&#39; meta.json)
remote_dir     := $(shell jq -r &#39;.remote_dir&#39; meta.json)
docker_image   := $(shell jq -r &#39;.docker_image&#39; meta.json)

help:
    @cat Makefile | grep &#39;# `&#39; | grep -v &#39;@cat Makefile&#39;

.PHONY: docker-image
docker-image:
    docker build \
        --progress plain \
        --pull \
        --tag $&#123;docker_image&#125; \
        --file Dockerfile \
        .

# `make build`                     Build
.PHONY: build
build: docker-image
    docker run \
        --rm \
        --name &quot;$&#123;container_name&#125;&quot; \
        -v &quot;$$(pwd)/:/data/&quot; \
        $&#123;docker_image&#125; \
            bash /data/build.sh

# `make shell`                     Shell
.PHONY: shell
shell: docker-image
    docker run \
        --rm \
        -it \
        -v &quot;$$(pwd)/:/data/&quot; \
        --workdir /data \
        $&#123;docker_image&#125; \
            bash

# `make publish`                   Publish
.PHONY: publish
publish:
    ssh &#39;root@$&#123;remote_server&#125;&#39; mkdir -p &#39;$&#123;remote_path&#125;/&#39;
    rsync \
        -a -r --no-i-r \
        --info=progress2 --info=name0 \
        --no-owner --no-group --no-perms \
        --delete \
        &quot;$$(pwd)/aptly/public/&quot; \
        &#39;root@$&#123;remote_server&#125;:$&#123;remote_dir&#125;/&#39;

# `make clean`                     Clean
.PHONY: clean
clean:
    docker stop $&#123;container_name&#125; &gt;/dev/null 2&gt;&amp;1 || true
    docker rm   $&#123;container_name&#125; &gt;/dev/null 2&gt;&amp;1 || true
</code></pre>

        </div>

        
            <section class="post-copyright">
                
                    <div>
                        <span>Author:</span>
                        <span>ismdeep</span>
                    </div>
                
                
                    <div>
                    Date: <a href="#">November 27, 2025&nbsp;&nbsp;14:18:12</a>
                    </div>
                
                
                    <div>
                        <span>Permalink:</span>
                        <span><a href="https://ismdeep.github.io/posts/2025-11-27-build-your-own-apt-repo.html">https://ismdeep.github.io/posts/2025-11-27-build-your-own-apt-repo.html</a></span>
                    </div>
                
                
                    <div>
                        <span>License:</span>
                        <span>Copyright (c) 2025 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </div>
                
                
            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                        
                            <a href="/tags/DevOps/">#DevOps</a>
                        
                    
                </span>
            </div>
        </section>

        <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
        <script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
        <script src="/js/md5.js"></script>
        <div style="margin-top: 2rem" id="gitalk-container"></div>
        <script>
          const gitalk = new Gitalk({
            clientID: 'fbdbc0d8c335f558f9b7',
            clientSecret: 'ee8a5301d43b6a7334ac0f34081006c097f75aa9',
            repo: 'ismdeep.github.io',
            owner: 'ismdeep',
            admin: ['ismdeep'],
            id: md5(location.pathname),
            language: 'en'
          })
          gitalk.render('gitalk-container')
        </script>


    </article>
</div>


              </div>
            </div>
          </div>
        </div>
        <div class="visualClear"></div>
      </div>
      <div id="column-one" lang="zh-Hans-CN" dir="ltr">
        <div role="navigation" class="portlet" id="p-personal" aria-labelledby="p-personal-label">
          <div class="pBody" style="margin-top: 4px;">
            <ul lang="zh-Hans-CN" dir="ltr">
              <li>
                <a href="/">首页</a>
              </li>
              <li>
                <a href="/archives/">文章列表</a>
              </li>
              <li>
                <a href="/tags/">分类索引</a>
              </li>
              <li>
                <a href="/posts/resource.html">资源列表</a>
              </li>
              <li>
                <a href="/about/">关于我</a>
              </li>
            </ul>
          </div>
        </div>
        <div class="portlet" id="p-logo" role="banner">
          <a href="/" class="mw-wiki-logo"></a>
        </div>
        <div id="sidebar">
          <div role="navigation" class="portlet mw-portlet mw-portlet-navigation" id="p-navigation" aria-labelledby="p-navigation-label">
            <h3 id="p-navigation-label" lang="zh-Hans-CN" dir="ltr">导航</h3>
            <div class="pBody">
              <ul lang="zh-Hans-CN" dir="ltr">
                <li id="n-mainpage-description" class="mw-list-item">
                  <a href="/">首页</a>
                </li>
                <li id="n-indexpage" class="mw-list-item">
                  <a href="/archives/">文章列表</a>
                </li>
                <li id="n-indexpage" class="mw-list-item">
                  <a href="/tags/">分类索引</a>
                </li>
                <li id="n-Featured_content" class="mw-list-item">
                  <a href="/posts/resource.html">资源列表</a>
                </li>
                <li id="n-Featured_content" class="mw-list-item">
                  <a href="/about/">关于我</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <!-- end of the left (by default at least) column -->
      <div class="visualClear"></div>
      <div id="footer" class="mw-footer" role="contentinfo" lang="zh-Hans-CN" dir="ltr">
        <ul id="f-list">
          <li id="about">
            <a href="/about/">关于我</a>
          </li>
        </ul>
      </div>
    </div>

  </body>
  <div id="immersive-translate-browser-popup" style="all: initial"></div>

</html>
